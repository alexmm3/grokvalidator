<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grok Validator PoC</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a24;
            --border: #2a2a3a;
            --text-primary: #e8e8ed;
            --text-secondary: #8888a0;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-amber: #f59e0b;
            --accent-purple: #8b5cf6;
            --gradient-start: #3b82f6;
            --gradient-end: #8b5cf6;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            background-image: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59, 130, 246, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(139, 92, 246, 0.1), transparent);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-top: 1rem;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .input-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-input);
        }
        
        .file-upload:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .file-upload.has-file {
            border-color: var(--accent-green);
            border-style: solid;
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        
        .file-upload-text {
            color: var(--text-secondary);
        }
        
        .file-name {
            margin-top: 0.75rem;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .image-preview {
            margin-top: 1rem;
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            display: none;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.2s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        textarea::placeholder {
            color: var(--text-secondary);
        }
        
        /* Duration Toggle */
        .duration-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .duration-toggle label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .toggle-buttons {
            display: flex;
            gap: 0;
            background: var(--bg-input);
            border-radius: 10px;
            padding: 4px;
            border: 1px solid var(--border);
        }
        
        .toggle-btn {
            padding: 0.5rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .toggle-btn.active {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .toggle-btn:not(.active):hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
        }
        
        .form-actions .btn-primary {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results-section {
            display: none;
        }
        
        .results-section.visible {
            display: block;
        }
        
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .result-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .result-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .step-badge {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .agent-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .agent-badge.agent2 {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .agent-badge.agent3 {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .result-body {
            padding: 1.5rem;
        }
        
        pre {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.7;
        }
        
        .routing-result {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .routing-neutral {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }
        
        .routing-adult {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--accent-purple);
        }
        
        .routing-blocked {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }
        
        .routing-icon {
            font-size: 1.5rem;
        }
        
        .enhanced-prompt {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.8;
        }
        
        /* NSFW badge styles */
        .nsfw-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nsfw-true {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: var(--accent-red);
        }
        
        .nsfw-false {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: var(--accent-green);
        }
        
        .fragment-header {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .agent1-flags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .error-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .error-card h3 {
            color: var(--accent-red);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .error-message {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .not-run {
            color: var(--text-secondary);
            font-style: italic;
            padding: 1rem;
            text-align: center;
        }
        
        /* Demo Note Banner */
        .demo-note {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.4);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .demo-note-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .demo-note-content {
            font-size: 0.85rem;
            color: var(--accent-amber);
        }
        
        .demo-note-content strong {
            color: var(--accent-red);
        }
        
        /* Fragment divider */
        .fragment-divider {
            margin: 1.5rem 0;
            border: none;
            border-top: 1px dashed var(--border);
        }
        
        /* Cost tracking styles */
        .cost-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .cost-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .cost-item {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }
        
        .cost-item-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .cost-item-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .cost-item-value.tokens {
            color: var(--accent-cyan);
        }
        
        .cost-item-value.usd {
            color: var(--accent-amber);
        }
        
        .cost-breakdown {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .cost-breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }
        
        .cost-breakdown-row .agent-name {
            color: var(--text-secondary);
        }
        
        .cost-breakdown-row .agent-cost {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        .cost-breakdown-row .tokens-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }
        
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        footer a {
            color: var(--accent-cyan);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Raw Output Panel */
        .raw-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .raw-panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .raw-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .raw-panel.visible {
            right: 0;
        }
        
        .raw-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        .raw-panel-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .raw-panel-header .step-indicator {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .raw-panel-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .raw-panel-close:hover {
            background: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }
        
        .raw-panel-content {
            flex: 1;
            overflow: auto;
            padding: 1.5rem;
        }
        
        .raw-panel-content pre {
            background: var(--bg-dark);
            margin: 0;
            font-size: 0.8rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .raw-section {
            margin-bottom: 1.5rem;
        }
        
        .raw-section:last-child {
            margin-bottom: 0;
        }
        
        .raw-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .raw-section-icon {
            font-size: 1rem;
        }
        
        .raw-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .raw-section-title.request {
            color: var(--accent-cyan);
        }
        
        .raw-section-title.response {
            color: var(--accent-green);
        }
        
        .raw-section pre {
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border);
        }
        
        .raw-panel-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: flex;
            gap: 0.75rem;
        }
        
        .btn-copy {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .btn-copy:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .btn-copy.copied {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }
        
        /* View Raw Button */
        .btn-view-raw {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            margin-left: auto;
        }
        
        .btn-view-raw:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .btn-view-raw:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* View Prompts Button */
        .btn-prompts {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-prompts:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }
        
        /* Prompts Panel (sliding from right) */
        .prompts-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1999;
        }
        
        .prompts-panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .prompts-panel {
            position: fixed;
            top: 0;
            right: -550px;
            width: 550px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }
        
        .prompts-panel.visible {
            right: 0;
        }
        
        .prompts-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        .prompts-panel-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .prompts-panel-header .prompts-indicator {
            background: linear-gradient(135deg, var(--accent-purple), var(--gradient-end));
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .prompts-panel-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .prompts-panel-close:hover {
            background: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }
        
        .prompts-panel-content {
            flex: 1;
            overflow: auto;
            padding: 1.5rem;
        }
        
        .prompt-section {
            margin-bottom: 1.5rem;
        }
        
        .prompt-section:last-child {
            margin-bottom: 0;
        }
        
        .prompt-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .prompt-agent-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .prompt-agent-badge.agent1 {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .prompt-agent-badge.agent2 {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .prompt-agent-badge.agent3 {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .prompt-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .prompt-model-tag {
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-input);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-left: auto;
        }
        
        .prompt-content {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-secondary);
        }
        
        .prompts-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        /* Routing Tree Visualization */
        .routing-tree-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(139, 92, 246, 0.08));
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        
        .routing-tree {
            padding: 1rem 0;
        }
        
        .tree-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            position: relative;
        }
        
        .tree-node {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.25rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            position: relative;
            max-width: 420px;
            width: 100%;
        }
        
        .tree-node.start-node {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.08);
        }
        
        .tree-node.agent1-node {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.08);
        }
        
        .tree-node.router-node {
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.08);
            border-width: 2px;
        }
        
        .tree-node.agent2-node {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.08);
        }
        
        .tree-node.agent3-node {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.08);
        }
        
        .tree-node.blocked-node {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.12);
            border-style: dashed;
        }
        
        .tree-node.result-node {
            border-color: var(--accent-amber);
            background: rgba(245, 158, 11, 0.08);
        }
        
        .tree-node.inactive {
            opacity: 0.35;
            filter: grayscale(0.5);
        }
        
        .tree-node.active {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        .node-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            width: 36px;
            text-align: center;
        }
        
        .node-content {
            flex: 1;
            min-width: 0;
        }
        
        .node-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.15rem;
        }
        
        .node-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .node-trigger {
            display: inline-block;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 0.35rem;
        }
        
        .node-trigger.green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .node-trigger.red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }
        
        .tree-connector {
            width: 2px;
            height: 24px;
            background: var(--border);
            position: relative;
        }
        
        .tree-connector.active {
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
        }
        
        .tree-connector.green {
            background: var(--accent-green);
        }
        
        .tree-connector.red {
            background: var(--accent-red);
        }
        
        .tree-branch {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            position: relative;
            width: 100%;
            max-width: 700px;
            justify-content: center;
        }
        
        .tree-branch-arm {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 300px;
        }
        
        .branch-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 32px;
            position: relative;
        }
        
        .branch-line-horizontal {
            position: absolute;
            top: 0;
            height: 2px;
            background: var(--border);
        }
        
        .branch-line-horizontal.left {
            right: 50%;
            width: 50%;
        }
        
        .branch-line-horizontal.right {
            left: 50%;
            width: 50%;
        }
        
        .branch-line-horizontal.active {
            background: var(--accent-green);
        }
        
        .branch-line-horizontal.active-red {
            background: var(--accent-red);
        }
        
        .branch-line-vertical {
            width: 2px;
            height: 100%;
            background: var(--border);
        }
        
        .branch-line-vertical.active {
            background: var(--accent-green);
        }
        
        .branch-line-vertical.active-red {
            background: var(--accent-red);
        }
        
        .branch-label {
            position: absolute;
            top: 6px;
            font-size: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .branch-label.left {
            right: calc(50% + 8px);
        }
        
        .branch-label.right {
            left: calc(50% + 8px);
        }
        
        .branch-label.active {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        
        .branch-label.active-red {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
        
        .tree-summary {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border);
            text-align: center;
        }
        
        .summary-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .summary-text strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        @media (max-width: 640px) {
            .tree-branch {
                flex-direction: column;
                gap: 0;
            }
            
            .tree-branch-arm {
                max-width: 100%;
            }
            
            .branch-connector {
                height: 24px;
            }
            
            .branch-line-horizontal {
                display: none;
            }
            
            .branch-label {
                position: static;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Grok Validator PoC</h1>
            <p class="subtitle">Image Analysis ‚Üí Content Routing ‚Üí Prompt Enhancement</p>
            <button class="btn-prompts" id="viewPromptsBtn">
                <span>üìú</span> View System Prompts
            </button>
        </header>
        
        <section class="input-section">
            <form id="pipelineForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Upload Image (JPEG/PNG, max 20 MiB)</label>
                        <div class="file-upload" id="fileUpload">
                            <input type="file" id="imageInput" accept="image/jpeg,image/png,image/jpg" required>
                            <div class="file-upload-icon">üì∑</div>
                            <div class="file-upload-text">Click or drag to upload an image</div>
                            <div class="file-name" id="fileName"></div>
                            <img class="image-preview" id="imagePreview" alt="Preview">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="promptInput">User Prompt</label>
                        <textarea 
                            id="promptInput" 
                            placeholder="Describe what you want the video to show. E.g., 'The person walks slowly toward the camera, smiling gently, with soft wind blowing through their hair.'"
                            required
                        ></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <div class="duration-toggle">
                        <label>Video Duration:</label>
                        <div class="toggle-buttons">
                            <button type="button" class="toggle-btn active" id="btn5sec" data-duration="5">5 sec</button>
                            <button type="button" class="toggle-btn" id="btn10sec" data-duration="10">10 sec</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="runBtn">
                        <span id="btnText">Run Pipeline</span>
                        <div class="spinner" id="spinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </section>
        
        <section class="results-section" id="resultsSection">
            <div class="error-card" id="errorCard" style="display: none;">
                <h3>‚ö†Ô∏è Error</h3>
                <p class="error-message" id="errorMessage"></p>
            </div>
            
            <!-- Agent 1 Result -->
            <div class="result-card">
                <div class="result-header">
                    <span class="step-badge">Step 1</span>
                    <h3>Agent 1: Image Analyzer</h3>
                    <button class="btn-view-raw" id="viewRawAgent1" disabled>
                        <span>{ }</span> View Raw
                    </button>
                </div>
                <div class="result-body">
                    <div id="agent1Output"><div class="not-run">Not run yet</div></div>
                </div>
            </div>
            
            <!-- Routing Decision -->
            <div class="result-card">
                <div class="result-header">
                    <span class="step-badge">Step 2</span>
                    <h3>Content Routing</h3>
                    <button class="btn-view-raw" id="viewRawRouting" disabled>
                        <span>{ }</span> View Raw
                    </button>
                </div>
                <div class="result-body" id="routingOutput">
                    <div class="not-run">Not run yet</div>
                </div>
            </div>
            
            <!-- Fragments Output -->
            <div class="result-card" id="fragmentsCard">
                <div class="result-header">
                    <span class="step-badge">Step 3</span>
                    <h3>Enhanced Prompts</h3>
                </div>
                <div class="result-body" id="fragmentsOutput">
                    <div class="not-run">Not run yet</div>
                </div>
            </div>
            
            <!-- Routing Tree Visualization -->
            <div class="result-card routing-tree-card" id="routingTreeCard" style="display: none;">
                <div class="result-header">
                    <span class="step-badge" style="background: rgba(139, 92, 246, 0.15); color: var(--accent-purple);">üå≥ Flow</span>
                    <h3>Pipeline Routing Visualization</h3>
                </div>
                <div class="result-body">
                    <div class="routing-tree" id="routingTree">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Cost Summary -->
            <div class="result-card cost-card" id="costCard" style="display: none;">
                <div class="result-header">
                    <span class="step-badge" style="background: rgba(245, 158, 11, 0.15); color: var(--accent-amber);">üí∞ Costs</span>
                    <h3>API Usage & Costs</h3>
                </div>
                <div class="result-body">
                    <div class="cost-summary">
                        <div class="cost-item">
                            <div class="cost-item-label">Total Tokens</div>
                            <div class="cost-item-value tokens" id="totalTokens">-</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-item-label">Input</div>
                            <div class="cost-item-value tokens" id="inputTokens">-</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-item-label">Output</div>
                            <div class="cost-item-value tokens" id="outputTokens">-</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-item-label">Total Cost</div>
                            <div class="cost-item-value usd" id="totalCost">-</div>
                        </div>
                    </div>
                    <div class="cost-breakdown" id="costBreakdown"></div>
                </div>
            </div>
        </section>
        
        <footer>
            PoC using <a href="https://docs.x.ai" target="_blank">xAI Grok API</a>
        </footer>
    </div>
    
    <!-- System Prompts Panel -->
    <div class="prompts-panel-overlay" id="promptsPanelOverlay"></div>
    <div class="prompts-panel" id="promptsPanel">
        <div class="prompts-panel-header">
            <h3>
                <span class="prompts-indicator">üìú</span>
                <span>System Prompts</span>
            </h3>
            <button class="prompts-panel-close" id="promptsPanelClose" title="Close">√ó</button>
        </div>
        <div class="prompts-panel-content" id="promptsPanelContent">
            <div class="prompts-loading">Loading prompts...</div>
        </div>
    </div>
    
    <!-- Raw Output Panel -->
    <div class="raw-panel-overlay" id="rawPanelOverlay"></div>
    <div class="raw-panel" id="rawPanel">
        <div class="raw-panel-header">
            <h3>
                <span class="step-indicator" id="panelStepIndicator">Step 1</span>
                <span id="panelTitle">Raw Output</span>
            </h3>
            <button class="raw-panel-close" id="rawPanelClose" title="Close">√ó</button>
        </div>
        <div class="raw-panel-content">
            <pre id="rawPanelContent">No data</pre>
        </div>
        <div class="raw-panel-actions">
            <button class="btn-copy" id="copyRawBtn">
                <span id="copyIcon">üìã</span>
                <span id="copyText">Copy to Clipboard</span>
            </button>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const form = document.getElementById('pipelineForm');
        const imageInput = document.getElementById('imageInput');
        const fileUpload = document.getElementById('fileUpload');
        const fileName = document.getElementById('fileName');
        const imagePreview = document.getElementById('imagePreview');
        const runBtn = document.getElementById('runBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const resultsSection = document.getElementById('resultsSection');
        const errorCard = document.getElementById('errorCard');
        const errorMessage = document.getElementById('errorMessage');
        const agent1Output = document.getElementById('agent1Output');
        const routingOutput = document.getElementById('routingOutput');
        const fragmentsOutput = document.getElementById('fragmentsOutput');
        const routingTreeCard = document.getElementById('routingTreeCard');
        const routingTree = document.getElementById('routingTree');
        const costCard = document.getElementById('costCard');
        
        // Duration toggle
        const btn5sec = document.getElementById('btn5sec');
        const btn10sec = document.getElementById('btn10sec');
        let selectedDuration = 5;
        
        // Raw panel elements
        const rawPanel = document.getElementById('rawPanel');
        const rawPanelOverlay = document.getElementById('rawPanelOverlay');
        const rawPanelClose = document.getElementById('rawPanelClose');
        const rawPanelContent = document.getElementById('rawPanelContent');
        const panelTitle = document.getElementById('panelTitle');
        const panelStepIndicator = document.getElementById('panelStepIndicator');
        const copyRawBtn = document.getElementById('copyRawBtn');
        const copyIcon = document.getElementById('copyIcon');
        const copyText = document.getElementById('copyText');
        
        // View Raw buttons
        const viewRawAgent1 = document.getElementById('viewRawAgent1');
        const viewRawRouting = document.getElementById('viewRawRouting');
        
        // Store raw data
        let rawData = {
            agent1: null,
            routing: null,
            fragments: []
        };
        let currentPanelData = null;
        
        // Duration toggle handlers
        btn5sec.addEventListener('click', () => {
            selectedDuration = 5;
            btn5sec.classList.add('active');
            btn10sec.classList.remove('active');
        });
        
        btn10sec.addEventListener('click', () => {
            selectedDuration = 10;
            btn10sec.classList.add('active');
            btn5sec.classList.remove('active');
        });
        
        // File upload handling
        fileUpload.addEventListener('click', () => imageInput.click());
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.style.borderColor = 'var(--accent-blue)';
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.style.borderColor = '';
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.style.borderColor = '';
            if (e.dataTransfer.files.length) {
                imageInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        imageInput.addEventListener('change', handleFileSelect);
        
        function handleFileSelect() {
            const file = imageInput.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileUpload.classList.add('has-file');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const image = imageInput.files[0];
            const prompt = document.getElementById('promptInput').value.trim();
            
            if (!image || !prompt) {
                showError('Please provide both an image and a prompt.');
                return;
            }
            
            setLoading(true);
            resetRawData();
            resultsSection.classList.add('visible');
            errorCard.style.display = 'none';
            routingTreeCard.style.display = 'none';
            costCard.style.display = 'none';
            agent1Output.innerHTML = '<div class="not-run">Processing...</div>';
            routingOutput.innerHTML = '<div class="not-run">Waiting for Agent 1...</div>';
            fragmentsOutput.innerHTML = '<div class="not-run">Waiting for routing...</div>';
            
            try {
                const formData = new FormData();
                formData.append('image', image);
                formData.append('prompt', prompt);
                formData.append('duration', selectedDuration);
                
                const response = await fetch('/run', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    showError(data.error || 'Pipeline failed');
                    return;
                }
                
                // Store and display Agent 1 result
                rawData.agent1 = data.agent1_details || { response: { parsed: data.agent1_result } };
                viewRawAgent1.disabled = false;
                displayAgent1(data.agent1_result);
                
                // Store and display Routing decision
                rawData.routing = data.routing;
                viewRawRouting.disabled = false;
                displayRouting(data.routing);
                
                // Display Fragments
                if (data.blocked) {
                    fragmentsOutput.innerHTML = '<div class="not-run">Blocked ‚Äî content did not pass safety gate</div>';
                } else {
                    displayFragments(data.fragments, data.routing.agent);
                }
                
                // Display routing tree visualization
                displayRoutingTree(
                    data.agent1_result,
                    data.routing,
                    data.fragments,
                    selectedDuration
                );
                
                // Display costs
                if (data.costs) {
                    displayCosts(data.costs);
                }
                
            } catch (err) {
                showError(`Network error: ${err.message}`);
            } finally {
                setLoading(false);
            }
        });
        
        function displayAgent1(agent1) {
            const nsfwBadge = agent1.nsfw 
                ? '<span class="nsfw-badge nsfw-true">üîû NSFW</span>' 
                : '<span class="nsfw-badge nsfw-false">‚úì SFW</span>';
            const minorBadge = agent1.minor_under_16 === 'no'
                ? '<span class="nsfw-badge nsfw-false">‚úì No Minors</span>'
                : agent1.minor_under_16 === 'yes'
                ? '<span class="nsfw-badge nsfw-true">‚ö†Ô∏è Minor Detected</span>'
                : '<span class="nsfw-badge" style="background: rgba(245, 158, 11, 0.15); border-color: rgba(245, 158, 11, 0.4); color: var(--accent-amber);">‚ö†Ô∏è Unclear</span>';
            
            agent1Output.innerHTML = `
                <div class="agent1-flags">
                    ${nsfwBadge}
                    ${minorBadge}
                    <span class="nsfw-badge" style="background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.4); color: var(--accent-blue);">üë• ${agent1.people_count} ${agent1.people_count === 1 ? 'person' : 'people'}</span>
                </div>
                <div style="margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">${escapeHtml(agent1.description || '')}</div>
            `;
        }
        
        function displayRouting(routing) {
            const isBlocked = routing.agent === 'blocked';
            const isAdult = routing.agent === 'agent3';
            
            let cssClass, icon, label;
            if (isBlocked) {
                cssClass = 'routing-blocked';
                icon = 'üö´';
                label = 'BLOCKED';
            } else if (isAdult) {
                cssClass = 'routing-adult';
                icon = 'üîû';
                label = 'ADULT CONTENT ‚Üí Agent 3';
            } else {
                cssClass = 'routing-neutral';
                icon = '‚úÖ';
                label = 'SAFE CONTENT ‚Üí Agent 2';
            }
            
            let gateInfo = '';
            if (routing.gate_applied) {
                gateInfo = `<br><span style="opacity: 0.7; font-size: 0.85rem;">Safety gate: ${routing.gate_passed ? 'PASSED' : 'FAILED'}</span>`;
            }
            
            routingOutput.innerHTML = `
                <div class="routing-result ${cssClass}">
                    <span class="routing-icon">${icon}</span>
                    <div>
                        <strong>${label}</strong>${gateInfo}<br>
                        <span style="opacity: 0.8">${routing.reason}</span>
                    </div>
                </div>
            `;
        }
        
        function displayFragments(fragments, agentUsed) {
            if (!fragments || fragments.length === 0) {
                fragmentsOutput.innerHTML = '<div class="not-run">No fragments generated</div>';
                return;
            }
            
            rawData.fragments = fragments.map(f => f.details);
            
            let html = '';
            
            fragments.forEach((fragment, idx) => {
                const isAgent3 = fragment.agent_used === 'agent3';
                const agentBadge = isAgent3 
                    ? '<span class="agent-badge agent3">Agent 3 (Adult)</span>'
                    : '<span class="agent-badge agent2">Agent 2 (Neutral)</span>';
                const nsfwBadge = fragment.result.nsfw 
                    ? '<span class="nsfw-badge nsfw-true">üîû NSFW</span>' 
                    : '<span class="nsfw-badge nsfw-false">‚úì SFW</span>';
                
                if (idx > 0) {
                    html += '<hr class="fragment-divider">';
                }
                
                // Demo note for Fragment 2+
                let demoNote = '';
                if (fragment._demo_note) {
                    demoNote = `
                        <div class="demo-note">
                            <span class="demo-note-icon">‚ö†Ô∏è</span>
                            <div class="demo-note-content">
                                <strong>DEMO MODE:</strong> Using same uploaded image.<br>
                                <strong>PRODUCTION:</strong> Should use the last frame of the previously generated video fragment as the first frame for this fragment.
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="fragment-item" data-index="${idx}">
                        <div class="fragment-header">
                            <span class="step-badge" style="background: rgba(139, 92, 246, 0.15); color: var(--accent-purple);">Fragment ${fragment.fragment_number}</span>
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">${fragment.time_range}</span>
                            ${agentBadge}
                            ${nsfwBadge}
                            <button class="btn-view-raw view-raw-fragment" data-index="${idx}">
                                <span>{ }</span> View Raw
                            </button>
                        </div>
                        ${demoNote}
                        <div class="enhanced-prompt">${escapeHtml(fragment.result.prompt || '')}</div>
                    </div>
                `;
            });
            
            fragmentsOutput.innerHTML = html;
            
            // Attach event listeners to fragment view raw buttons
            document.querySelectorAll('.view-raw-fragment').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.index);
                    if (rawData.fragments[idx]) {
                        openRawPanel(`3.${idx + 1}`, `Fragment ${idx + 1}`, rawData.fragments[idx]);
                    }
                });
            });
        }
        
        function displayCosts(costs) {
            costCard.style.display = 'block';
            
            document.getElementById('totalTokens').textContent = costs.total.total_tokens.toLocaleString();
            document.getElementById('inputTokens').textContent = costs.total.input_tokens.toLocaleString();
            document.getElementById('outputTokens').textContent = costs.total.output_tokens.toLocaleString();
            document.getElementById('totalCost').textContent = '$' + costs.total.total_cost_usd.toFixed(6);
            
            let breakdownHtml = '';
            
            if (costs.agent1) {
                breakdownHtml += `
                    <div class="cost-breakdown-row">
                        <span class="agent-name">Agent 1 (${costs.agent1.model})</span>
                        <span>
                            <span class="agent-cost">$${costs.agent1.total_cost_usd.toFixed(6)}</span>
                            <span class="tokens-detail">${costs.agent1.input_tokens} in / ${costs.agent1.output_tokens} out</span>
                        </span>
                    </div>
                `;
            }
            
            if (costs.fragments && costs.fragments.length > 0) {
                costs.fragments.forEach((fragCost, idx) => {
                    breakdownHtml += `
                        <div class="cost-breakdown-row">
                            <span class="agent-name">Fragment ${idx + 1} (${fragCost.model})</span>
                            <span>
                                <span class="agent-cost">$${fragCost.total_cost_usd.toFixed(6)}</span>
                                <span class="tokens-detail">${fragCost.input_tokens} in / ${fragCost.output_tokens} out</span>
                            </span>
                        </div>
                    `;
                });
            }
            
            document.getElementById('costBreakdown').innerHTML = breakdownHtml;
        }
        
        function displayRoutingTree(agent1Result, routing, fragments, duration) {
            routingTreeCard.style.display = 'block';
            
            const isBlocked = routing.agent === 'blocked';
            const isAgent3 = routing.agent === 'agent3';
            const isAgent2 = routing.agent === 'agent2';
            const numFragments = fragments ? fragments.length : 0;
            
            // Determine triggers
            const nsfw = agent1Result.nsfw;
            const minorStatus = agent1Result.minor_under_16;
            const peopleCount = agent1Result.people_count;
            
            // Build the tree HTML
            let html = `
                <div class="tree-flow">
                    <!-- Start Node -->
                    <div class="tree-node start-node active">
                        <div class="node-icon">üì•</div>
                        <div class="node-content">
                            <div class="node-title">Input Received</div>
                            <div class="node-detail">Image + User prompt ‚Üí ${duration}s video request</div>
                        </div>
                    </div>
                    
                    <div class="tree-connector active"></div>
                    
                    <!-- Agent 1 Node -->
                    <div class="tree-node agent1-node active">
                        <div class="node-icon">üîç</div>
                        <div class="node-content">
                            <div class="node-title">Agent 1: Image Analyzer</div>
                            <div class="node-detail">Vision analysis ‚Üí Extract metadata</div>
                            <div class="node-trigger">NSFW: ${nsfw ? 'true' : 'false'} | Minor: ${minorStatus} | People: ${peopleCount}</div>
                        </div>
                    </div>
                    
                    <div class="tree-connector active"></div>
                    
                    <!-- Router Node -->
                    <div class="tree-node router-node active">
                        <div class="node-icon">‚ö°</div>
                        <div class="node-content">
                            <div class="node-title">Routing Decision</div>
                            <div class="node-detail">${routing.reason}</div>
                            ${nsfw && !isBlocked ? `<div class="node-trigger red">NSFW=true ‚Üí Safety gate check</div>` : ''}
                            ${!nsfw ? `<div class="node-trigger green">NSFW=false ‚Üí Safe path</div>` : ''}
                            ${isBlocked ? `<div class="node-trigger red">GATE FAILED: minor_under_16="${minorStatus}"</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Branch split -->
                    <div class="tree-branch">
                        <!-- Left branch: Agent 2 (Neutral) -->
                        <div class="tree-branch-arm">
                            <div class="branch-connector">
                                <div class="branch-line-horizontal left ${isAgent2 ? 'active' : ''}"></div>
                                <div class="branch-line-vertical ${isAgent2 ? 'active' : ''}"></div>
                                <span class="branch-label left ${isAgent2 ? 'active' : ''}">SFW</span>
                            </div>
                            <div class="tree-node agent2-node ${isAgent2 ? 'active' : 'inactive'}">
                                <div class="node-icon">‚ú®</div>
                                <div class="node-content">
                                    <div class="node-title">Agent 2: Neutral</div>
                                    <div class="node-detail">Safe prompt enhancement</div>
                                    ${isAgent2 ? `<div class="node-trigger green">SELECTED ‚úì</div>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right branch: Agent 3 (Adult) / Blocked -->
                        <div class="tree-branch-arm">
                            <div class="branch-connector">
                                <div class="branch-line-horizontal right ${isAgent3 || isBlocked ? 'active-red' : ''}"></div>
                                <div class="branch-line-vertical ${isAgent3 || isBlocked ? 'active-red' : ''}"></div>
                                <span class="branch-label right ${isAgent3 || isBlocked ? 'active-red' : ''}">NSFW</span>
                            </div>
                            ${isBlocked ? `
                                <div class="tree-node blocked-node active">
                                    <div class="node-icon">üö´</div>
                                    <div class="node-content">
                                        <div class="node-title">BLOCKED</div>
                                        <div class="node-detail">Safety gate rejected</div>
                                        <div class="node-trigger red">Minor detected/unclear</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="tree-node agent3-node ${isAgent3 ? 'active' : 'inactive'}">
                                    <div class="node-icon">üîû</div>
                                    <div class="node-content">
                                        <div class="node-title">Agent 3: Adult</div>
                                        <div class="node-detail">Adult content enhancement</div>
                                        ${isAgent3 ? `<div class="node-trigger red">SELECTED ‚úì</div>` : ''}
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
            `;
            
            // Add result node if not blocked
            if (!isBlocked && numFragments > 0) {
                html += `
                    <div class="tree-connector ${isAgent2 ? 'green' : 'red'}"></div>
                    
                    <div class="tree-node result-node active">
                        <div class="node-icon">üé¨</div>
                        <div class="node-content">
                            <div class="node-title">Output: ${numFragments} Fragment${numFragments > 1 ? 's' : ''}</div>
                            <div class="node-detail">${duration}s video ‚Üí ${numFragments}√ó enhanced prompts generated</div>
                            ${numFragments > 1 ? `<div class="node-trigger">Fragment 2 uses continuation context</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`; // Close tree-flow
            
            // Add summary
            const pathTaken = isBlocked ? '‚ùå Input ‚Üí Agent 1 ‚Üí Router ‚Üí BLOCKED' 
                            : isAgent2 ? '‚úÖ Input ‚Üí Agent 1 ‚Üí Router ‚Üí Agent 2 ‚Üí Output'
                            : '‚ö†Ô∏è Input ‚Üí Agent 1 ‚Üí Router ‚Üí Agent 3 (Adult) ‚Üí Output';
            
            html += `
                <div class="tree-summary">
                    <div class="summary-text">
                        <strong>Path taken:</strong> ${pathTaken}
                    </div>
                </div>
            `;
            
            routingTree.innerHTML = html;
        }
        
        function setLoading(loading) {
            runBtn.disabled = loading;
            btnText.textContent = loading ? 'Running...' : 'Run Pipeline';
            spinner.style.display = loading ? 'block' : 'none';
        }
        
        function showError(message) {
            resultsSection.classList.add('visible');
            errorCard.style.display = 'block';
            errorMessage.textContent = message;
            agent1Output.innerHTML = '<div class="not-run">Failed</div>';
            routingOutput.innerHTML = '<div class="not-run">Failed</div>';
            fragmentsOutput.innerHTML = '<div class="not-run">Failed</div>';
            resetRawData();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function resetRawData() {
            rawData = { agent1: null, routing: null, fragments: [] };
            viewRawAgent1.disabled = true;
            viewRawRouting.disabled = true;
        }
        
        // Raw Panel Functions
        function openRawPanel(step, title, data) {
            panelStepIndicator.textContent = `Step ${step}`;
            panelTitle.textContent = title;
            
            let html = '';
            
            if (data.request) {
                html += `
                    <div class="raw-section">
                        <div class="raw-section-header">
                            <span class="raw-section-icon">üì§</span>
                            <span class="raw-section-title request">Request Sent</span>
                        </div>
                        <pre>${escapeHtml(JSON.stringify(data.request, null, 2))}</pre>
                    </div>
                `;
            }
            
            if (data.response) {
                html += `
                    <div class="raw-section">
                        <div class="raw-section-header">
                            <span class="raw-section-icon">üì•</span>
                            <span class="raw-section-title response">Response Received</span>
                        </div>
                        <pre>${escapeHtml(JSON.stringify(data.response, null, 2))}</pre>
                    </div>
                `;
            }
            
            // For routing, show the full object
            if (data.agent && !data.request) {
                html = `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
            }
            
            if (!html) {
                html = `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
            }
            
            rawPanelContent.innerHTML = html;
            currentPanelData = data;
            rawPanel.classList.add('visible');
            rawPanelOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
            resetCopyButton();
        }
        
        function closeRawPanel() {
            rawPanel.classList.remove('visible');
            rawPanelOverlay.classList.remove('visible');
            document.body.style.overflow = '';
            currentPanelData = null;
        }
        
        function resetCopyButton() {
            copyIcon.textContent = 'üìã';
            copyText.textContent = 'Copy to Clipboard';
            copyRawBtn.classList.remove('copied');
        }
        
        async function copyToClipboard() {
            try {
                const textToCopy = currentPanelData 
                    ? JSON.stringify(currentPanelData, null, 2)
                    : rawPanelContent.textContent;
                await navigator.clipboard.writeText(textToCopy);
                copyIcon.textContent = '‚úì';
                copyText.textContent = 'Copied!';
                copyRawBtn.classList.add('copied');
                setTimeout(resetCopyButton, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }
        
        // Event listeners
        rawPanelClose.addEventListener('click', closeRawPanel);
        rawPanelOverlay.addEventListener('click', closeRawPanel);
        copyRawBtn.addEventListener('click', copyToClipboard);
        
        // System Prompts Panel
        const viewPromptsBtn = document.getElementById('viewPromptsBtn');
        const promptsPanel = document.getElementById('promptsPanel');
        const promptsPanelOverlay = document.getElementById('promptsPanelOverlay');
        const promptsPanelClose = document.getElementById('promptsPanelClose');
        const promptsPanelContent = document.getElementById('promptsPanelContent');
        
        async function loadAndShowPrompts() {
            promptsPanel.classList.add('visible');
            promptsPanelOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
            
            promptsPanelContent.innerHTML = '<div class="prompts-loading">Loading prompts...</div>';
            
            try {
                const response = await fetch('/prompts');
                const data = await response.json();
                
                promptsPanelContent.innerHTML = `
                    <div class="prompt-section">
                        <div class="prompt-section-header">
                            <span class="prompt-agent-badge agent1">Agent 1</span>
                            <span class="prompt-section-title">${escapeHtml(data.agent1.name)}</span>
                            <span class="prompt-model-tag">${escapeHtml(data.agent1.model)}</span>
                        </div>
                        <div class="prompt-content">${escapeHtml(data.agent1.prompt)}</div>
                    </div>
                    
                    <div class="prompt-section">
                        <div class="prompt-section-header">
                            <span class="prompt-agent-badge agent2">Agent 2</span>
                            <span class="prompt-section-title">${escapeHtml(data.agent2.name)}</span>
                            <span class="prompt-model-tag">${escapeHtml(data.agent2.model)}</span>
                        </div>
                        <div class="prompt-content">${escapeHtml(data.agent2.prompt)}</div>
                    </div>
                    
                    <div class="prompt-section">
                        <div class="prompt-section-header">
                            <span class="prompt-agent-badge agent3">Agent 3</span>
                            <span class="prompt-section-title">${escapeHtml(data.agent3.name)}</span>
                            <span class="prompt-model-tag">${escapeHtml(data.agent3.model)}</span>
                        </div>
                        <div class="prompt-content">${escapeHtml(data.agent3.prompt)}</div>
                    </div>
                `;
            } catch (err) {
                promptsPanelContent.innerHTML = `<div class="prompts-loading" style="color: var(--accent-red);">Failed to load prompts: ${escapeHtml(err.message)}</div>`;
            }
        }
        
        function closePromptsPanel() {
            promptsPanel.classList.remove('visible');
            promptsPanelOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }
        
        viewPromptsBtn.addEventListener('click', loadAndShowPrompts);
        promptsPanelClose.addEventListener('click', closePromptsPanel);
        promptsPanelOverlay.addEventListener('click', closePromptsPanel);
        
        // Escape key handler for all panels
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (promptsPanel.classList.contains('visible')) {
                    closePromptsPanel();
                } else if (rawPanel.classList.contains('visible')) {
                    closeRawPanel();
                }
            }
        });
        
        viewRawAgent1.addEventListener('click', () => {
            if (rawData.agent1) {
                openRawPanel('1', 'Agent 1: Image Analyzer', rawData.agent1);
            }
        });
        
        viewRawRouting.addEventListener('click', () => {
            if (rawData.routing) {
                openRawPanel('2', 'Content Routing', rawData.routing);
            }
        });
    </script>
</body>
</html>
